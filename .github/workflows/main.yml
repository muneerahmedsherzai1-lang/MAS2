name: Ultimate RDP Self-Hosted Windows 11 Pro

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: self-hosted
    timeout-minutes: 0   # Unlimited runtime

    steps:
      - name: Enable RDP & Harden Firewall
        shell: pwsh
        run: |
          Write-Host "=== Enabling RDP & configuring firewall ==="
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
          # Disable NLA (for legacy clients)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0
          # Enable Remote Desktop firewall rules
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service TermService -Force

      - name: Create Persistent RDP User
        shell: pwsh
        run: |
          $username = "MAS"
          $password = ConvertTo-SecureString "dont" -AsPlainText -Force
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $password -AccountNeverExpires -PasswordNeverExpires -Description "GitHub RDP User"
          }
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
          Write-Host "RDP user ensured: $username"

      - name: Install & Update Tailscale
        shell: pwsh
        run: |
          Write-Host "=== Installing Tailscale ==="
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait
          Remove-Item $msi -Force
          # Up Tailscale with auth key
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win11-runner --accept-routes
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"

      - name: Lock RDP to Tailscale Only
        shell: pwsh
        run: |
          $ip = $env:TAILSCALE_IP
          if ($ip) {
            Write-Host "Restricting RDP firewall to Tailscale IP $ip"
            Disable-NetFirewallRule -DisplayGroup "Remote Desktop"
            New-NetFirewallRule -DisplayName "RDP-Tailscale" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow -RemoteAddress $ip
          }

      - name: Verify RDP & System Health
        shell: pwsh
        run: |
          Write-Host "=== Verifying RDP connectivity and system health ==="
          Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          Write-Host "=== System Info ==="
          Get-ComputerInfo | Select-Object CsName, OsName, OsVersion, WindowsProductName, OsArchitecture, CsProcessors, CsTotalPhysicalMemory
          Get-CimInstance Win32_VideoController | Select-Object Name, DriverVersion, AdapterRAM

      - name: Enable Auto Windows Updates
        shell: pwsh
        run: |
          Write-Host "=== Enabling automatic Windows Updates ==="
          Set-Service -Name wuauserv -StartupType Automatic
          Start-Service wuauserv

      - name: Monitor & Auto-Restart RDP / Tailscale
        shell: pwsh
        run: |
          Write-Host "=== Starting persistent monitor loop ==="
          while ($true) {
            # Check RDP service
            $term = Get-Service TermService
            if ($term.Status -ne "Running") {
              Write-Host "RDP service stopped. Restarting..."
              Start-Service TermService
            }

            # Check Tailscale status
            $ts = & "C:\Program Files\Tailscale\tailscale.exe" status
            if ($ts -notmatch "100.100") {
              Write-Host "Tailscale disconnected. Restarting Tailscale..."
              & "C:\Program Files\Tailscale\tailscale.exe" down
              & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win11-runner --accept-routes
            }

            # Log heartbeat
            Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - RDP & Tailscale OK"

            Start-Sleep -Seconds 300
          }
