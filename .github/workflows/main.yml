name: Windows 11 RDP + Tailscale + Disk Check

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: self-hosted
    timeout-minutes: 7200

    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:

      - name: Show Disk Space
        shell: pwsh
        run: |
          Write-Host "===== DISK SPACE ====="
          Get-Volume | Select DriveLetter, FileSystemLabel, SizeRemaining, Size | Format-Table

      - name: Show System Information
        shell: pwsh
        run: |
          Write-Host "===== SYSTEM INFO ====="
          Get-CimInstance Win32_ComputerSystem | 
            Select Manufacturer, Model, TotalPhysicalMemory | Format-List

          Write-Host "===== CPU ====="
          Get-CimInstance Win32_Processor | 
            Select Name, NumberOfCores, NumberOfLogicalProcessors | Format-Table

          Write-Host "===== GPU ====="
          Get-CimInstance Win32_VideoController | 
            Select Name, DriverVersion | Format-Table

      - name: Check For Unallocated Space (Safe)
        shell: pwsh
        run: |
          Write-Host "===== DISK EXPANSION CHECK ====="

          $disk = Get-Disk | Where-Object { $_.Number -eq 0 }
          $partition = Get-Partition -DiskNumber 0 | 
                       Where-Object DriveLetter -ne $null | 
                       Select-Object -First 1

          if (!$disk -or !$partition) {
            Write-Host "Disk or partition not found. Skipping."
            exit 0
          }

          $sizeInfo = Get-PartitionSupportedSize `
            -DiskNumber 0 `
            -PartitionNumber $partition.PartitionNumber

          if ($sizeInfo.SizeMax -gt $partition.Size) {
              Resize-Partition `
                -DiskNumber 0 `
                -PartitionNumber $partition.PartitionNumber `
                -Size $sizeInfo.SizeMax
              Write-Host "Drive expanded successfully."
          }
          else {
              Write-Host "No unallocated space available."
          }

      - name: Enable RDP
        shell: pwsh
        run: |
          Write-Host "===== ENABLING RDP ====="
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $username = "MAS"
          $password = ConvertTo-SecureString "YourStrongPassword123!" -AsPlainText -Force

          if (!(Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password $password -PasswordNeverExpires
          }

          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

          Write-Host "RDP User Ready: MAS"

      - name: Install Tailscale
        shell: pwsh
        run: |
          if (!(Test-Path "C:\Program Files\Tailscale\tailscale.exe")) {
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $msi = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest $url -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait
          }

      - name: Connect Tailscale
        shell: pwsh
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up `
            --authkey=$env:TAILSCALE_AUTH_KEY `
            --hostname=win11-rdp `
            --accept-routes

          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          "TAILSCALE_IP=$ip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "Tailscale IP: $ip"

      - name: Restrict RDP to Tailscale IP
        shell: pwsh
        run: |
          if ($env:TAILSCALE_IP) {
            Remove-NetFirewallRule -DisplayName "RDP-Tailscale" -ErrorAction SilentlyContinue
            New-NetFirewallRule -DisplayName "RDP-Tailscale" `
              -Direction Inbound -Protocol TCP -LocalPort 3389 `
              -RemoteAddress $env:TAILSCALE_IP -Action Allo_
