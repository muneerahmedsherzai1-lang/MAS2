# ==============================
# Ultimate Free Worldwide RDP Setup
# ==============================

# --- Step 1: Install Tailscale ---
Write-Host "=== Installing Tailscale ==="
$msi = "$env:TEMP\tailscale.msi"
Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait
Remove-Item $msi -Force

# Replace YOUR_AUTH_KEY with your Tailscale auth key
$authKey = "YOUR_AUTH_KEY"
& "C:\Program Files\Tailscale\tailscale.exe" up --authkey $authKey --hostname "win11-host" --accept-routes

# Get Tailscale IP
$tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
Write-Host "Tailscale IP: $tsIP"

# --- Step 2: Enable RDP ---
Write-Host "=== Enabling RDP ==="
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
# Optional: Disable NLA for older clients
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0
# Enable firewall rules
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# --- Step 3: Create RDP User ---
Write-Host "=== Creating RDP User ==="
$username = "MAS"
$password = ConvertTo-SecureString "YourStrongPassword123!" -AsPlainText -Force
if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
    New-LocalUser -Name $username -Password $password -AccountNeverExpires -PasswordNeverExpires -Description "RDP User"
}
Add-LocalGroupMember -Group "Administrators" -Member $username
Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
Write-Host "RDP user ensured: $username"

# --- Step 4: Lock RDP to Tailscale Only ---
Write-Host "=== Locking RDP firewall to Tailscale IP ==="
if ($tsIP) {
    Disable-NetFirewallRule -DisplayGroup "Remote Desktop"
    New-NetFirewallRule -DisplayName "RDP-Tailscale" `
        -Direction Inbound `
        -LocalPort 3389 `
        -Protocol TCP `
        -Action Allow `
        -RemoteAddress $tsIP
    Write-Host "RDP firewall restricted to: $tsIP"
}

# --- Step 5: Enable Auto Windows Updates ---
Write-Host "=== Enabling automatic Windows Updates ==="
Set-Service -Name wuauserv -StartupType Automatic
Start-Service wuauserv

# --- Step 6: Optional Monitor Loop for RDP & Tailscale ---
Write-Host "=== Starting monitor loop for RDP & Tailscale ==="
Start-Job -ScriptBlock {
    while ($true) {
        # Check RDP service
        if ((Get-Service TermService).Status -ne "Running") {
            Start-Service TermService
        }

        # Check Tailscale connection
        $tsStatus = & "C:\Program Files\Tailscale\tailscale.exe" status
        if ($tsStatus -notmatch "100.") {
            & "C:\Program Files\Tailscale\tailscale.exe" down
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $using:authKey --hostname "win11-host" --accept-routes
        }

        Start-Sleep -Seconds 300
    }
}
Write-Host "Monitor loop started. RDP and Tailscale will auto-reconnect if needed."

Write-Host "âœ… Setup complete! Connect via Tailscale IP or MagicDNS hostname."
Write-Host "Example: mstsc /v:$tsIP"
