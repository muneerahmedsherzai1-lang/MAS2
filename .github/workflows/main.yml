name: RDP-Linux

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: [self-hosted, linux]
    timeout-minutes: 0   # unlimited on self-hosted

    steps:
      - name: Install Desktop + xRDP
        run: |
          sudo apt update
          sudo apt install -y ubuntu-desktop xrdp curl

          # Enable xRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Allow RDP port
          sudo ufw allow 3389/tcp || true

      - name: Create RDP User
        run: |
          USER="rdp"
          PASS=$(tr -dc 'A-Za-z0-9!@#$%&' </dev/urandom | head -c 16)

          if ! id "$USER" &>/dev/null; then
            sudo useradd -m -s /bin/bash $USER
            echo "$USER:$PASS" | sudo chpasswd
            sudo usermod -aG sudo $USER
          fi

          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=rdp-linux-$(hostname)

          sleep 5
          IP=$(tailscale ip -4)
          echo "TS_IP=$IP" >> $GITHUB_ENV

      - name: Show Connection Info
        run: |
          echo ""
          echo "=============================="
          echo "   LINUX RDP READY"
          echo "=============================="
          echo "Address : $TS_IP"
          echo "Port    : 3389"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          echo "=============================="
